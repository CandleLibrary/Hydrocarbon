/* Maps */

// Goto lookup maps
gt0 = [-4294967295,-1,1,2,3,4,6,7,5,8,9,-20,10],
gt1 = [-4294967295,-10,17,18],
gt2 = [-4294967295,-4,20,6,7,5,8,9,-20,10],
gt3 = [-4294967295,-18,21,22,-4,23,24],
gt4 = [-4294967295,-18,28,22,-4,23,24],
gt5 = [-4294967295,-20,29,-3,30,31,32],
gt6 = [-4294967295,-32,35,36],
gt7 = [-4294967295,-29,41],
gt8 = [-4294967295,-32,43,36],
gt9 = [-4294967295,-11,44,-18,45],
gt10 = [-4294967295,-28,46,47],
gt11 = [-4294967295,-19,49,-4,23,24],
gt12 = [-4294967295,-29,50],
gt13 = [-4294967295,-29,51],
gt14 = [-4294967295,-33,56],
gt15 = [-4294967295,-31,58,-1,56],
gt16 = [-4294967295,-12,64,65,66,67,71,-4,70,69,68,73,75,76,74,-1,78,-5,72],
gt17 = [-4294967295,-16,87,-4,88,85,-1,73,75,76,74,-1,78,-4,84,86],
gt18 = [-4294967295,-13,94,66,67,71,-4,70,69,68,73,75,76,74,-1,78,-5,72],
gt19 = [-4294967295,-34,95],
gt20 = [-4294967295,-17,98,-2,99,-3,30,31,32],
gt21 = [-4294967295,-17,100,-2,99,-3,30,31,32],
gt22 = [-4294967295,-17,101,-2,99,-3,30,31,32],
gt23 = [-4294967295,-32,102,36],
gt24 = [-4294967295,-20,106,-3,30,31,32],
gt25 = [-4294967295,-32,110,36],
gt26 = [-4294967295,-29,111],

// State action lookup maps
sm0=[-4294967295,1,-20,1,2,3,4,5,6,4294967295,-4,4294967295,-27,7],
sm1=[-4294967295,8,-3,4294967295,-4,4294967295],
sm2=[-4294967295,9,-3,4294967295,-4,4294967295,-11,10,-15,9],
sm3=[-4294967295,11,-20,11,2,3,4,5,6,4294967295,-4,4294967295,-27,7],
sm4=[-4294967295,-21,12,12,12,12,12,12,12,-3,4294967295,-4,4294967295,-27,12],
sm5=[-4294967295,-21,13,13,13,13,13,13,13,-3,4294967295,-4,4294967295,-27,13],
sm6=[-4294967295,14,4294967295,-4,4294967295,-22,15,16],
sm7=[-4294967295,17,4294967295,-4,4294967295,-22,15,16,18],
sm8=[-4294967295,-1,19,20,-1,4294967295,21,4294967295],
sm9=[-4294967295,-2,22,-1,4294967295,-4,4294967295],
sm10=[-4294967295,23,-3,4294967295,-4,4294967295,-11,10,-15,7],
sm11=[-4294967295,24,-3,4294967295,-4,4294967295,-11,24,-15,24],
sm12=[-4294967295,-21,25,25,25,25,25,25,25,-3,4294967295,-4,4294967295,-27,25],
sm13=[-4294967295,-9,4294967295,14,4294967295,-27,15,16],
sm14=[-4294967295,-9,4294967295,-22,26,26,26,4294967295],
sm15=[-4294967295,-9,4294967295,-22,27,27,27,4294967295],
sm16=[-4294967295,-1,28,-2,4294967295,-4,4294967295],
sm17=[-4294967295,-1,29,29,29,29,29,29,4294967295,-4,4294967295],
sm18=[-4294967295,-4,4294967295,-3,30,4294967295],
sm19=[-4294967295,-1,19,20,-1,4294967295,-4,4294967295,21],
sm20=[-4294967295,31,31,31,-1,4294967295,-4,4294967295,31,31,31],
sm21=[-4294967295,32,32,32,-1,4294967295,-4,4294967295,32,32,32],
sm22=[-4294967295,-4,4294967295,-4,4294967295],
sm23=[-4294967295,33,-1,33,-1,4294967295,-4,4294967295,-11,33,33,33,33,-7,33,33,33,33,-32,33,-2,33,-2,33,33],
sm24=[-4294967295,34,19,20,-6,4294967295,35,4294967295,21],
sm25=[-4294967295,36,-3,4294967295,-4,4294967295,-11,36,-15,36],
sm26=[-4294967295,-4,4294967295,-4,4294967295,-12,37],
sm27=[-4294967295,-4,4294967295,-4,4294967295,-12,38],
sm28=[-4294967295,-21,39,39,39,39,39,39,39,-3,4294967295,-4,4294967295,-27,39],
sm29=[-4294967295,-9,4294967295,-22,40,40,40,4294967295],
sm30=[-4294967295,41,-1,41,-1,4294967295,-4,4294967295,-11,41,-1,41,41,-7,41,41,41,41,-32,41,-2,41,-2,41,41],
sm31=[-4294967295,42,-1,42,-1,4294967295,-4,4294967295,-11,42,-1,42,42,-7,42,42,42,42,-32,42,-2,42,-2,42,42],
sm32=[-4294967295,-21,43,43,43,43,43,43,43,-3,4294967295,-4,4294967295,-27,43],
sm33=[-4294967295,44,44,44,-1,4294967295,-4,4294967295,-11,44,-1,44,44,-7,44,44,44,-5,44,44,44,44],
sm34=[-4294967295,-21,45,45,45,45,45,45,45,-3,4294967295,-4,4294967295,-27,45],
sm35=[-4294967295,46,46,46,-1,4294967295,-4,4294967295,46,46,46],
sm36=[-4294967295,-21,47,47,47,47,47,47,47,-3,4294967295,-4,4294967295,-27,47],
sm37=[-4294967295,-21,48,48,48,48,48,48,48,-3,4294967295,-4,4294967295,-27,48],
sm38=[-4294967295,-21,49,49,49,49,49,49,49,-3,4294967295,-4,4294967295,-27,49],
sm39=[-4294967295,50,51,-1,22,-1,4294967295,-4,4294967295,-14,52,-6,53,15,16,18,-5,54],
sm40=[-4294967295,-21,55,55,55,55,55,55,55,-3,4294967295,-4,4294967295,-27,55],
sm41=[-4294967295,56,-3,4294967295,-4,4294967295,-11,56,-1,57,-13,56],
sm42=[-4294967295,58,-3,4294967295,-4,4294967295,-11,58,-1,58,-13,58],
sm43=[-4294967295,59,-3,4294967295,-4,4294967295,-11,59,-1,59,-13,59],
sm44=[-4294967295,51,-1,22,-1,4294967295,-4,4294967295,-11,60,-1,60,52,-7,15,16,18,-2,60,-2,61,50],
sm45=[-4294967295,60,-3,4294967295,-4,4294967295,-11,60,-1,60,-13,60],
sm46=[-4294967295,62,-1,62,-1,4294967295,-4,4294967295,-11,62,-1,62,62,-7,62,62,62,-2,62,-2,62,62],
sm47=[-4294967295,63,-1,63,-1,4294967295,-4,4294967295,-11,63,-1,63,63,-7,63,63,63,-2,63,-2,63,63],
sm48=[-4294967295,64,-1,64,-1,4294967295,-4,4294967295,-11,64,-1,64,64,-7,64,64,64,-2,64,-2,64,64],
sm49=[-4294967295,-4,4294967295,-4,4294967295,-15,65,-1,66,67],
sm50=[-4294967295,68,4294967295,-4,4294967295],
sm51=[-4294967295,69,-3,4294967295,-4,4294967295,-11,69,-1,69,-13,69],
sm52=[-4294967295,70,-3,4294967295,-4,4294967295,-11,70,-1,70,-13,70,-2,70],
sm53=[-4294967295,71,-3,4294967295,-4,4294967295,-11,71,-1,71,-13,71],
sm54=[-4294967295,-4,4294967295,-4,4294967295,-30,72],
sm55=[-4294967295,73,-1,73,-1,4294967295,-4,4294967295,-11,73,-1,73,73,-7,73,73,73,-2,73,-2,73,73],
sm56=[-4294967295,-41,74,68,4294967295,-4,4294967295],
sm57=[-4294967295,75,-3,4294967295,-4,4294967295,-11,75,-1,75,-13,75],
sm58=[-4294967295,76,-3,4294967295,-4,4294967295,-11,76,-1,76,-13,76],
sm59=[-4294967295,-4,4294967295,-4,4294967295,-31,74],
sm60=[-4294967295,77,78,4294967295,-4,4294967295],
sm61=[-4294967295,79,17,4294967295,-4,4294967295,-22,15,16,18],
sm62=[-4294967295,80,80,80,80,80,4294967295,-4,4294967295],
sm63=[-4294967295,81,17,4294967295,-4,4294967295,-22,15,16,18],
sm64=[-4294967295,82,17,4294967295,-4,4294967295,-22,15,16,18],
sm65=[-4294967295,83,19,20,-1,4294967295,21,4294967295],
sm66=[-4294967295,84,-1,84,-1,4294967295,-4,4294967295,-11,84,-1,84,84,-7,84,84,84,-2,84,-2,84,84],
sm67=[-4294967295,85,85,85,85,85,4294967295,-4,4294967295],
sm68=[-4294967295,86,-1,86,-1,4294967295,-4,4294967295,-11,86,-1,86,86,-7,86,86,86,-2,86,-2,86,86],
sm69=[-4294967295,87,19,20,-1,4294967295,21,4294967295],
sm70=[-4294967295,88,-3,4294967295,-4,4294967295,-11,88,-1,88,-13,88],
sm71=[-4294967295,89,-3,4294967295,-4,4294967295,-11,89,-1,89,-13,89],

// Symbol Lookup map
lu = new Map([["any",13],[1,1],[2,2],[4,3],[8,4],[16,5],[32,6],[64,7],[128,8],[256,9],[512,10],[3,11],[264,11],["@SYMBOL",14],["@PREC",16],["@IGNORE",18],["@NAME",19],["@EXT",20],["--",21],["→",22],["│",23],["((",24],["EXC",25],["))",26],["ERR",27],["IGN",28],[null,null],["$",30],["ɛ",31],["θ",32],["τ",33],["\\",34],["#",37],[";",38],["↦",40],["cstr",41],["{",42],["}",43],["^",44]]),

// States 
state = [sm0,
sm1,
sm2,
sm3,
sm4,
sm5,
sm5,
sm5,
sm5,
sm5,
sm5,
sm6,
sm6,
sm7,
sm8,
sm9,
sm8,
sm10,
sm11,
sm9,
sm12,
sm13,
sm14,
sm15,
sm15,
sm15,
sm9,
sm9,
sm13,
sm16,
sm17,
sm17,
sm17,
sm17,
sm18,
sm19,
sm20,
sm21,
sm21,
sm21,
sm21,
sm22,
sm23,
sm24,
sm25,
sm25,
sm26,
sm27,
sm28,
sm29,
sm30,
sm31,
sm32,
sm22,
sm33,
sm34,
sm35,
sm36,
sm37,
sm38,
sm38,
sm38,
sm39,
sm40,
sm41,
sm42,
sm43,
sm44,
sm45,
sm45,
sm46,
sm46,
sm46,
sm47,
sm47,
sm47,
sm47,
sm47,
sm48,
sm49,
sm50,
sm51,
sm52,
sm39,
sm53,
sm54,
sm55,
sm55,
sm55,
sm56,
sm7,
sm7,
sm7,
sm8,
sm57,
sm58,
sm59,
sm60,
sm61,
sm62,
sm63,
sm64,
sm65,
sm8,
sm9,
sm66,
sm67,
sm66,
sm66,
sm68,
sm69,
sm70,
sm71],

/* Functions */

//Error Functions
e = (tk,r,o,l,s)=>{
        if(l.END)
            l.throw("Unexpected end of input");
        else
            l.throw(`unexpected token ${l.tx} on input ${s} `)
    }, 
eh = [e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e,
e],

//Empty Function
nf = ()=>-1, 

//Environment Functions

redv = (ret, fn, plen, ln, t, e, o, l, s) => {        ln = max(o.length - plen);        o[ln] = fn(o.slice(plen), e, l, s);        o.length = ln + 1;        return ret    },
rednv = (ret, fn, plen, ln, t, e, o, l, s) => {        ln = max(o.length - plen);        o[ln] = new fn(o.slice(plen), e, l, s);        o.length = ln + 1;        return ret    },
redn = (ret, t, e, o) => (o.push(null), ret),
shftf = (ret, fn, t, e, o, l, s) => (fn(o, e, l, s), ret),

//Sparse Map Lookup
lsm = (index, map) => {    if (map[0] > 0xFFFFFFFF) return map[index];    for (let i = 1, ind = 0, l = map.length, n = 0; i < l && ind <= index; i++) {        console.log(index, map, ind, i);        if (ind !== index) {            if ((n = map[i]) > -1) ind++;            else ind += -n;        } else return map[i];    }    return -1;},

//State Action Functions
state_funct = [(...v)=>((redn(2051,..v))),
()=>(62),
()=>(46),
()=>(58),
()=>(54),
()=>(50),
()=>(66),
()=>(5),
(...v)=>((redn(10243,..v))),
()=>(78),
()=>(2055),
()=>(3079),
()=>(4103),
()=>(102),
()=>(106),
()=>(110),
()=>(134),
()=>(138),
()=>(154),
()=>(150),
()=>(162),
()=>(170),
()=>(1035),
()=>(10247),
()=>(3083),
()=>(18439),
()=>(19463),
()=>(214),
()=>(20487),
()=>(218),
()=>(32775),
()=>(33799),
()=>(29703),
()=>(242),
()=>(246),
()=>(10251),
()=>(250),
()=>(28679),
()=>(7183),
()=>(18443),
()=>(24587),
()=>(25611),
()=>(5135),
()=>(26635),
()=>(8207),
()=>(32779),
()=>(9231),
()=>(30735),
()=>(31751),
()=>(310),
()=>(330),
()=>(318),
()=>(326),
()=>(322),
()=>(6163),
()=>(11283),
()=>(334),
()=>(12295),
()=>(13319),
()=>(14343),
()=>(358),
()=>(15367),
()=>(21511),
()=>(27655),
()=>(362),
()=>(366),
()=>(370),
()=>(374),
()=>(23559),
()=>(22535),
()=>(14347),
()=>(386),
()=>(15371),
()=>(390),
()=>(12303),
()=>(14351),
()=>(418),
()=>(414),
()=>(422),
()=>(17415),
()=>(430),
()=>(434),
()=>(438),
()=>(16403),
()=>(17419),
()=>(35859),
()=>(450),
()=>(34835),
()=>(34839)],

//Goto Lookup Functions
goto = [v=>lsm(v,gt0),
nf,
v=>lsm(v,gt1),
v=>lsm(v,gt2),
nf,
nf,
nf,
nf,
nf,
nf,
nf,
v=>lsm(v,gt3),
v=>lsm(v,gt4),
v=>lsm(v,gt5),
v=>lsm(v,gt6),
v=>lsm(v,gt7),
v=>lsm(v,gt8),
v=>lsm(v,gt9),
nf,
v=>lsm(v,gt10),
nf,
v=>lsm(v,gt11),
nf,
nf,
nf,
nf,
v=>lsm(v,gt12),
v=>lsm(v,gt13),
v=>lsm(v,gt11),
nf,
nf,
nf,
nf,
nf,
nf,
v=>lsm(v,gt14),
nf,
nf,
nf,
nf,
nf,
nf,
nf,
v=>lsm(v,gt15),
nf,
nf,
nf,
nf,
nf,
nf,
nf,
nf,
nf,
nf,
nf,
nf,
nf,
nf,
nf,
nf,
nf,
nf,
v=>lsm(v,gt16),
nf,
nf,
nf,
nf,
v=>lsm(v,gt17),
nf,
nf,
nf,
nf,
nf,
nf,
nf,
nf,
nf,
nf,
nf,
nf,
nf,
nf,
nf,
v=>lsm(v,gt18),
nf,
v=>lsm(v,gt19),
nf,
nf,
nf,
nf,
v=>lsm(v,gt20),
v=>lsm(v,gt21),
v=>lsm(v,gt22),
v=>lsm(v,gt23),
nf,
nf,
nf,
nf,
v=>lsm(v,gt24),
nf,
v=>lsm(v,gt24),
v=>lsm(v,gt24),
v=>lsm(v,gt14),
v=>lsm(v,gt25),
v=>lsm(v,gt26),
nf,
nf,
nf,
nf,
nf,
v=>lsm(v,gt14),
nf,
nf];

function getToken(l, SYM_LU) {
    if (l.END) return 0; //$

    switch (l.ty) {
        case 2:
            if (SYM_LU.has(l.tx)) return SYM_LU.get(l.tx);
            return 2;
        case 1:
            return 1;
        case 4:
            return 3;
        case 256:
            return 9;
        case 8:
            return 4;
        case 512:
            return 10;
        default:
            return SYM_LU.get(l.tx) || SYM_LU.get(l.ty);
    }
}

 function parser(l, e = {}){
    l.IWS = false;
    /*
    if(symbols.length > 0){
        symbols.forEach(s=> {l.addSymbol(s)});
        l.tl = 0;
        l.next();
    }
    */

    const o = [], ss = [0,0];
    
    let time = 1000000, RECOVERING = 1,
        tk = getToken(l, lu), p = l.copy(), sp = 1, len = 0, off= 0;
    
    outer:

    while(time-- > 0){

        let fn = lsm(tk, state[ss[sp]]) || 0, r, st = 0, gt = -1, c = 0;

        if(fn == 0xFFFFFFFF){
            //Ignore the token
            l.next();
            tk = getToken(l, lu);
            continue;
        }

        if(fn > 0){
            console.log(tk, "funciton", fn-1, state_funct[fn-1].toString(), state_funct[fn-1]()&3)
            r = state_funct[fn-1](tk, e, o, l, ss[sp-1]);
        } else {

            if(RECOVERING > 1){
                if(tk !== lu.get(l.ty)){
                    RECOVERING = 0;
                    tk = l.ty;
                    continue;
                }

                if(tk !== undefined){
                    tk = undefined;
                    RECOVERING = 1;
                    continue;
                }

            }

            tk = getToken(l, lu);

            //Error Encountered 
            //r = re[ss[sp]];
            console.log(ss, ss[sp])
            const recovery_token = eh[ss[sp]](tk, e, o, l, p, ss[sp]);
            
            if(RECOVERING > 0 && typeof(recovery_token) == "string"){
                RECOVERING = -1; // To prevent infinite recursion
                tk = recovery_token;
                //reset current token
                l.tl = 0;
                continue;
            }
        }

        st = r >> 2;

        switch(r & 3){
            case 0: // ERROR
                
                if(tk == "$")
                    l.throw("Unexpected end of input");

                l.throw(`Unexpected token [${RECOVERING ? l.next().tx : l.tx}]`); 

                return [null];

            case 1: // ACCEPT
                break outer;

            case 2: //SHIFT
                o.push((tk[0] == "θ") ? l.tx : tk); 
                ss.push(off, r >> 2); 
                sp+=2; 
                p.sync(l);
                l.next(); 
                off = l.off; 
                tk = getToken(l, lu); 
                RECOVERING++;
                break;

            case 3: // REDUCE

                len = (r & 0x3FC) >> 1;

                ss.length -= len;   
                sp -= len; 

                gt = goto[ss[sp]](r >> 10);

                console.log(ss[sp], gt, goto[ss[sp]], r >> 10)

                if(gt < 0)
                    l.throw("Invalid state reached!");
                
                ss.push(off, gt); sp+=2; 
                break;
        }  
    }
    console.log(time)
    return o[0];
}
